<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حجز المواعيد - نظام إدارة الانتظار</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .form-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .time-slot {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .time-slot:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .time-slot.selected {
            background: #fbbf24;
            color: #1e3c72;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(251, 191, 36, 0.4);
        }
        
        .time-slot.booked {
            background: #ef4444;
            color: white;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .calendar-day {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .calendar-day.selected {
            background: #fbbf24;
            color: #1e3c72;
        }
        
        .calendar-day.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .arabic-number {
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="bg-white/10 backdrop-blur-md border-b border-white/20 p-6">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <i class="fas fa-calendar-alt text-3xl text-yellow-300 ml-3"></i>
                <div>
                    <h1 class="text-2xl font-bold text-white">حجز المواعيد</h1>
                    <p class="text-gray-200 text-sm">احجز موعدك بسهولة ويسر</p>
                </div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-yellow-300 arabic-number" id="currentTime"></div>
                <div class="text-sm text-gray-300" id="currentDate"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Booking Form -->
            <div class="lg:col-span-2">
                <div class="form-container rounded-2xl p-8">
                    <h2 class="text-3xl font-bold text-white mb-8 text-center">
                        <i class="fas fa-calendar-plus text-yellow-300 mr-3"></i>
                        نموذج الحجز
                    </h2>
                    
                    <form id="bookingForm" class="space-y-6">
                        <!-- Personal Information -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-white mb-2">الاسم رباعي *</label>
                                <input type="text" id="clientName" required class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-yellow-300" placeholder="أدخل اسمك الرباعي">
                            </div>
                            <div>
                                <label class="block text-white mb-2">الرقم القومي *</label>
                                <input type="text" id="nationalId" required maxlength="14" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-yellow-300" placeholder="أدخل رقمك القومي">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-white mb-2">رقم التليفون *</label>
                                <input type="tel" id="phoneNumber" required class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-yellow-300" placeholder="أدخل رقم تليفونك">
                            </div>
                            <div>
                                <label class="block text-white mb-2">البريد الإلكتروني</label>
                                <input type="email" id="email" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-yellow-300" placeholder="أدخل بريدك الإلكتروني">
                            </div>
                        </div>

                        <!-- Clinic Selection -->
                        <div>
                            <label class="block text-white mb-2">العيادة *</label>
                            <select id="clinicSelect" required class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-yellow-300">
                                <option value="">-- اختر العيادة --</option>
                            </select>
                        </div>

                        <!-- Date Selection -->
                        <div>
                            <label class="block text-white mb-2">التاريخ المطلوب *</label>
                            <div id="calendar" class="bg-white/20 rounded-lg p-4">
                                <!-- Calendar will be generated here -->
                            </div>
                        </div>

                        <!-- Time Selection -->
                        <div>
                            <label class="block text-white mb-2">الوقت المطلوب *</label>
                            <div id="timeSlots" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <!-- Time slots will be generated here -->
                            </div>
                        </div>

                        <!-- Visit Reason -->
                        <div>
                            <label class="block text-white mb-2">سبب الزيارة</label>
                            <textarea id="visitReason" rows="3" class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-yellow-300" placeholder="أدخل سبب الزيارة أو الأعراض"></textarea>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center">
                            <button type="submit" class="bg-yellow-400 text-purple-900 px-8 py-4 rounded-lg font-bold text-lg hover:bg-yellow-300 transition-colors">
                                <i class="fas fa-calendar-check mr-2"></i>
                                حجز الموعد
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Available Appointments -->
                <div class="form-container rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-white mb-4">
                        <i class="fas fa-info-circle text-yellow-300 mr-2"></i>
                        معلومات الحجز
                    </h3>
                    <div class="space-y-4 text-white">
                        <div class="flex justify-between">
                            <span>الشيفت الصباحي:</span>
                            <span class="text-yellow-300">٨ ص - ٢ م</span>
                        </div>
                        <div class="flex justify-between">
                            <span>الشيفت المسائي:</span>
                            <span class="text-yellow-300">٢ م - ٨ م</span>
                        </div>
                        <div class="flex justify-between">
                            <span>مدة الموعد:</span>
                            <span class="text-yellow-300">٣٠ دقيقة</span>
                        </div>
                        <div class="flex justify-between">
                            <span>الحد الأقصى يومياً:</span>
                            <span class="text-yellow-300">١٦ مريض</span>
                        </div>
                    </div>
                </div>

                <!-- Booking Status -->
                <div class="form-container rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-white mb-4">
                        <i class="fas fa-calendar-day text-yellow-300 mr-2"></i>
                        حالة الحجز
                    </h3>
                    <div id="bookingStatus" class="text-white">
                        <div class="text-center text-gray-300">
                            <i class="fas fa-calendar-times text-4xl mb-2"></i>
                            <p>لم يتم اختيار تاريخ بعد</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="form-container rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-white mb-4">
                        <i class="fas fa-chart-bar text-yellow-300 mr-2"></i>
                        إحصائيات سريعة
                    </h3>
                    <div class="space-y-3 text-white">
                        <div class="flex justify-between">
                            <span>المواعيد اليوم:</span>
                            <span class="text-yellow-300 arabic-number" id="todayAppointments">٠</span>
                        </div>
                        <div class="flex justify-between">
                            <span>المواعيد هذا الأسبوع:</span>
                            <span class="text-yellow-300 arabic-number" id="weekAppointments">٠</span>
                        </div>
                        <div class="flex justify-between">
                            <span>المواعيد المتاحة:</span>
                            <span class="text-green-400 arabic-number" id="availableSlots">٣٢</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800">تم الحجز بنجاح!</h2>
            </div>
            
            <div id="bookingDetails" class="space-y-3 text-gray-700 mb-6">
                <!-- Booking details will be shown here -->
            </div>
            
            <div class="text-center">
                <button id="closeConfirmation" class="bg-green-500 text-white px-8 py-3 rounded-lg font-bold hover:bg-green-600 transition-colors">
                    <i class="fas fa-check mr-2"></i>
                    فهمت
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
        <i class="fas fa-check mr-2"></i>
        <span id="notificationText">تمت العملية بنجاح</span>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        let selectedDate = null;
        let selectedTime = null;
        let selectedClinic = null;
        let availableSlots = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadClinics();
            generateCalendar();
            generateTimeSlots();
            setupEventListeners();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            loadBookingStats();
        });

        // Load clinics
        function loadClinics() {
            clinicsRef.on('value', (snapshot) => {
                const clinics = snapshot.val() || {};
                const clinicSelect = document.getElementById('clinicSelect');
                clinicSelect.innerHTML = '<option value="">-- اختر العيادة --</option>';

                Object.keys(clinics).forEach(clinicId => {
                    const clinic = clinics[clinicId];
                    const option = document.createElement('option');
                    option.value = clinicId;
                    option.textContent = `${clinic.name} (رقم ${convertToArabicNumbers(clinicId)})`;
                    clinicSelect.appendChild(option);
                });
            });
        }

        // Generate calendar
        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Generate next 30 days
            let calendarHTML = '<div class="grid grid-cols-7 gap-2">';
            
            // Day headers
            const dayHeaders = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            dayHeaders.forEach(day => {
                calendarHTML += `<div class="text-center text-sm font-bold text-white p-2">${day}</div>`;
            });
            
            // Generate days
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const dayNumber = date.getDate();
                const dayName = dayHeaders[date.getDay()];
                const isWeekend = date.getDay() === 5 || date.getDay() === 6; // Friday or Saturday
                
                const dayClass = isWeekend ? 'calendar-day disabled bg-red-500/30' : 'calendar-day bg-white/20';
                
                calendarHTML += `
                    <div class="${dayClass} rounded-lg p-2 text-center text-white cursor-pointer" 
                         data-date="${date.toISOString().split('T')[0]}"
                         onclick="selectDate('${date.toISOString().split('T')[0]}')">
                        <div class="text-sm">${dayName}</div>
                        <div class="text-lg font-bold arabic-number">${convertToArabicNumbers(dayNumber)}</div>
                    </div>
                `;
            }
            
            calendarHTML += '</div>';
            calendar.innerHTML = calendarHTML;
        }

        // Generate time slots
        function generateTimeSlots() {
            const timeSlots = document.getElementById('timeSlots');
            const slots = [
                // Morning shift (8 AM - 2 PM)
                { time: '08:00', period: 'صباحاً' },
                { time: '08:30', period: 'صباحاً' },
                { time: '09:00', period: 'صباحاً' },
                { time: '09:30', period: 'صباحاً' },
                { time: '10:00', period: 'صباحاً' },
                { time: '10:30', period: 'صباحاً' },
                { time: '11:00', period: 'صباحاً' },
                { time: '11:30', period: 'صباحاً' },
                { time: '12:00', period: 'ظهراً' },
                { time: '12:30', period: 'ظهراً' },
                { time: '13:00', period: 'ظهراً' },
                { time: '13:30', period: 'ظهراً' },
                // Evening shift (2 PM - 8 PM)
                { time: '14:00', period: 'ظهراً' },
                { time: '14:30', period: 'ظهراً' },
                { time: '15:00', period: 'ظهراً' },
                { time: '15:30', period: 'ظهراً' },
                { time: '16:00', period: 'ظهراً' },
                { time: '16:30', period: 'ظهراً' },
                { time: '17:00', period: 'مساءً' },
                { time: '17:30', period: 'مساءً' },
                { time: '18:00', period: 'مساءً' },
                { time: '18:30', period: 'مساءً' },
                { time: '19:00', period: 'مساءً' },
                { time: '19:30', period: 'مساءً' }
            ];
            
            let slotsHTML = '';
            slots.forEach((slot, index) => {
                const timeValue = slot.time;
                const displayTime = convertToArabicNumbers(slot.time.replace(':', '։'));
                const displayPeriod = slot.period;
                
                slotsHTML += `
                    <div class="time-slot bg-white/20 rounded-lg p-3 text-center text-white" 
                         data-time="${timeValue}"
                         onclick="selectTime('${timeValue}')">
                        <div class="font-bold arabic-number">${displayTime}</div>
                        <div class="text-sm">${displayPeriod}</div>
                    </div>
                `;
            });
            
            timeSlots.innerHTML = slotsHTML;
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('bookingForm').addEventListener('submit', submitBooking);
            document.getElementById('clinicSelect').addEventListener('change', updateBookingStatus);
            document.getElementById('closeConfirmation').addEventListener('click', hideConfirmationModal);
        }

        // Select date
        function selectDate(date) {
            // Remove previous selection
            document.querySelectorAll('.calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
            
            // Add selection to clicked date
            document.querySelector(`[data-date="${date}"]`).classList.add('selected');
            selectedDate = date;
            
            updateBookingStatus();
            showNotification(`تم اختيار تاريخ: ${new Date(date).toLocaleDateString('ar-SA')}`);
        }

        // Select time
        function selectTime(time) {
            const timeSlot = document.querySelector(`[data-time="${time}"]`);
            
            if (timeSlot.classList.contains('booked')) {
                showNotification('هذا الوقت محجوز بالفعل', 'error');
                return;
            }
            
            // Remove previous selection
            document.querySelectorAll('.time-slot.selected').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // Add selection to clicked time
            timeSlot.classList.add('selected');
            selectedTime = time;
            
            showNotification(`تم اختيار الوقت: ${convertToArabicNumbers(time.replace(':', '։'))}`);
        }

        // Update booking status
        function updateBookingStatus() {
            const clinicId = document.getElementById('clinicSelect').value;
            const statusDiv = document.getElementById('bookingStatus');
            
            if (!clinicId || !selectedDate) {
                statusDiv.innerHTML = `
                    <div class="text-center text-gray-300">
                        <i class="fas fa-calendar-times text-4xl mb-2"></i>
                        <p>لم يتم اختيار تاريخ بعد</p>
                    </div>
                `;
                return;
            }
            
            // Check available slots for selected date and clinic
            appointmentsRef.orderByChild('clinic').equalTo(clinicId).once('value', (snapshot) => {
                const appointments = snapshot.val() || {};
                let bookedSlots = 0;
                
                Object.values(appointments).forEach(appointment => {
                    if (appointment.date === selectedDate) {
                        bookedSlots++;
                    }
                });
                
                const availableSlots = 32 - bookedSlots; // 16 morning + 16 evening
                
                statusDiv.innerHTML = `
                    <div class="text-center text-white">
                        <i class="fas fa-calendar-check text-4xl mb-2 text-green-400"></i>
                        <div class="mb-2">التاريخ: ${new Date(selectedDate).toLocaleDateString('ar-SA')}</div>
                        <div class="mb-2">المواعيد المحجوزة: <span class="text-yellow-300 arabic-number">${convertToArabicNumbers(bookedSlots)}</span></div>
                        <div>المواعيد المتاحة: <span class="text-green-400 arabic-number">${convertToArabicNumbers(availableSlots)}</span></div>
                    </div>
                `;
                
                // Update time slots availability
                updateTimeSlotsAvailability(bookedSlots);
            });
        }

        // Update time slots availability
        function updateTimeSlotsAvailability(bookedSlots) {
            // This is a simplified version - in real system, you'd check specific time slots
            const timeSlots = document.querySelectorAll('.time-slot');
            
            // Mark some slots as booked based on bookedSlots count
            timeSlots.forEach((slot, index) => {
                slot.classList.remove('booked');
                if (index < bookedSlots) {
                    slot.classList.add('booked');
                }
            });
        }

        // Submit booking
        function submitBooking(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('clientName').value,
                nationalId: document.getElementById('nationalId').value,
                phone: document.getElementById('phoneNumber').value,
                email: document.getElementById('email').value,
                clinic: document.getElementById('clinicSelect').value,
                date: selectedDate,
                time: selectedTime,
                visitReason: document.getElementById('visitReason').value,
                timestamp: new Date().toISOString()
            };
            
            // Validate required fields
            if (!formData.name || !formData.nationalId || !formData.phone || !formData.clinic || !formData.date || !formData.time) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            // Validate national ID length
            if (formData.nationalId.length !== 14) {
                showNotification('الرقم القومي يجب أن يكون 14 رقم', 'error');
                return;
            }
            
            // Save booking to Firebase
            appointmentsRef.push(formData)
                .then(() => {
                    showConfirmationModal(formData);
                    showNotification('تم حجز الموعد بنجاح');
                    resetForm();
                })
                .catch((error) => {
                    showNotification('خطأ في الحجز: ' + error.message, 'error');
                });
        }

        // Show confirmation modal
        function showConfirmationModal(bookingData) {
            const modal = document.getElementById('confirmationModal');
            const details = document.getElementById('bookingDetails');
            
            clinicsRef.child(bookingData.clinic).once('value', (snapshot) => {
                const clinic = snapshot.val();
                
                details.innerHTML = `
                    <div class="text-right">
                        <div class="mb-2"><strong>الاسم:</strong> ${bookingData.name}</div>
                        <div class="mb-2"><strong>العيادة:</strong> ${clinic.name}</div>
                        <div class="mb-2"><strong>التاريخ:</strong> ${new Date(bookingData.date).toLocaleDateString('ar-SA')}</div>
                        <div class="mb-2"><strong>الوقت:</strong> ${convertToArabicNumbers(bookingData.time.replace(':', '։'))}</div>
                        <div class="mb-2"><strong>رقم التليفون:</strong> ${bookingData.phone}</div>
                    </div>
                `;
                
                modal.classList.add('show');
            });
        }

        // Hide confirmation modal
        function hideConfirmationModal() {
            document.getElementById('confirmationModal').classList.remove('show');
        }

        // Reset form
        function resetForm() {
            document.getElementById('bookingForm').reset();
            selectedDate = null;
            selectedTime = null;
            
            // Remove selections
            document.querySelectorAll('.calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
            document.querySelectorAll('.time-slot.selected').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            updateBookingStatus();
        }

        // Load booking stats
        function loadBookingStats() {
            const today = new Date().toISOString().split('T')[0];
            const weekFromNow = new Date();
            weekFromNow.setDate(weekFromNow.getDate() + 7);
            
            appointmentsRef.once('value', (snapshot) => {
                const appointments = snapshot.val() || {};
                let todayCount = 0;
                let weekCount = 0;
                
                Object.values(appointments).forEach(appointment => {
                    if (appointment.date === today) {
                        todayCount++;
                    }
                    if (appointment.date >= today && appointment.date <= weekFromNow.toISOString().split('T')[0]) {
                        weekCount++;
                    }
                });
                
                document.getElementById('todayAppointments').textContent = convertToArabicNumbers(todayCount);
                document.getElementById('weekAppointments').textContent = convertToArabicNumbers(weekCount);
                
                const availableSlots = Math.max(0, 32 - todayCount);
                document.getElementById('availableSlots').textContent = convertToArabicNumbers(availableSlots);
            });
        }

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('ar-SA');
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ar-SA', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white px-6 py-3 rounded-lg shadow-lg show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Initialize animations
        anime({
            targets: '.form-container',
            translateY: [50, 0],
            opacity: [0, 1],
            delay: anime.stagger(200),
            duration: 800,
            easing: 'easeOutQuart'
        });
    </script>
</body>
</html>