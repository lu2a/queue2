<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحة الطباعة - نظام إدارة الانتظار</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .print-container {
            background: white;
            padding: 20px;
            margin: 20px auto;
            max-width: 210mm;
            min-height: 297mm;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }
        
        .ticket-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px;
        }
        
        .ticket {
            width: 5cm;
            height: 5cm;
            border: 2px solid #2a5298;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .ticket-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2a5298;
            margin-bottom: 5px;
        }
        
        .ticket-center {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .ticket-date {
            font-size: 0.7rem;
            color: #6c757d;
        }
        
        .ticket-wait {
            font-size: 0.6rem;
            color: #dc3545;
            margin-top: 5px;
        }
        
        .arabic-number {
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
        }
        
        @media print {
            body {
                background: white;
            }
            .print-container {
                box-shadow: none;
                margin: 0;
                padding: 10px;
            }
            .no-print {
                display: none !important;
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="no-print bg-white/10 backdrop-blur-md border-b border-white/20 p-6">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <i class="fas fa-print text-3xl text-yellow-300 ml-3"></i>
                <div>
                    <h1 class="text-2xl font-bold text-white">صفحة الطباعة</h1>
                    <p class="text-gray-200 text-sm">طباعة تذاكر الانتظار</p>
                </div>
            </div>
            <div class="flex space-x-4">
                <button id="printBtn" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors">
                    <i class="fas fa-print mr-2"></i>
                    طباعة
                </button>
                <button id="settingsBtn" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                    <i class="fas fa-cog mr-2"></i>
                    إعدادات
                </button>
            </div>
        </div>
    </div>

    <!-- Print Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <i class="fas fa-cog text-4xl text-purple-600 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800">إعدادات الطباعة</h2>
            </div>
            
            <form id="settingsForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2">العيادة</label>
                    <select id="clinicSelect" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                        <option value="">-- اختر عيادة --</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2">من رقم</label>
                        <input type="number" id="fromNumber" min="1" value="1" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">إلى رقم</label>
                        <input type="number" id="toNumber" min="1" value="20" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">مدة الانتظار لكل عميل (دقائق)</label>
                    <input type="number" id="waitTime" min="1" value="5" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">اسم المركز</label>
                    <input type="text" id="centerName" value="المركز الطبي" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                </div>
                
                <div class="flex space-x-4">
                    <button type="button" id="cancelSettings" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors">
                        إلغاء
                    </button>
                    <button type="submit" class="flex-1 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors">
                        <i class="fas fa-check mr-2"></i>
                        تطبيق
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Print Container -->
    <div class="print-container">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 id="printCenterName" class="text-3xl font-bold text-gray-800 mb-2">المركز الطبي</h1>
            <div class="text-lg text-gray-600">تذاكر الانتظار</div>
            <div class="text-sm text-gray-500" id="printDate"></div>
        </div>

        <!-- Tickets Grid -->
        <div id="ticketsGrid" class="ticket-grid">
            <!-- Tickets will be generated here -->
        </div>

        <!-- Footer -->
        <div class="text-center mt-8 text-sm text-gray-500">
            <p>شكراً لاختياركم مركزنا - نسعى لتقديم أفضل خدمة لكم</p>
            <p>يرجى الانتظار بصبر وسيتم النداء على رقمكم قريباً</p>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
        <i class="fas fa-check mr-2"></i>
        <span id="notificationText">تمت العملية بنجاح</span>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        let printSettings = {
            clinic: '',
            fromNumber: 1,
            toNumber: 20,
            waitTime: 5,
            centerName: 'المركز الطبي'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadClinics();
            setupEventListeners();
            updatePrintDate();
            
            // Check for URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('clinic')) {
                printSettings.clinic = urlParams.get('clinic');
                printSettings.fromNumber = parseInt(urlParams.get('from')) || 1;
                printSettings.toNumber = parseInt(urlParams.get('to')) || 20;
                generateTickets();
            }
        });

        // Load clinics
        function loadClinics() {
            clinicsRef.on('value', (snapshot) => {
                const clinics = snapshot.val() || {};
                const clinicSelect = document.getElementById('clinicSelect');
                clinicSelect.innerHTML = '<option value="">-- اختر عيادة --</option>';

                Object.keys(clinics).forEach(clinicId => {
                    const clinic = clinics[clinicId];
                    const option = document.createElement('option');
                    option.value = clinicId;
                    option.textContent = `${clinic.name} (رقم ${convertToArabicNumbers(clinicId)})`;
                    clinicSelect.appendChild(option);
                });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('settingsBtn').addEventListener('click', showSettingsModal);
            document.getElementById('cancelSettings').addEventListener('click', hideSettingsModal);
            document.getElementById('settingsForm').addEventListener('submit', applySettings);
            document.getElementById('printBtn').addEventListener('click', printTickets);
        }

        // Show settings modal
        function showSettingsModal() {
            document.getElementById('settingsModal').classList.add('show');
            
            // Load current settings
            document.getElementById('clinicSelect').value = printSettings.clinic;
            document.getElementById('fromNumber').value = printSettings.fromNumber;
            document.getElementById('toNumber').value = printSettings.toNumber;
            document.getElementById('waitTime').value = printSettings.waitTime;
            document.getElementById('centerName').value = printSettings.centerName;
        }

        // Hide settings modal
        function hideSettingsModal() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        // Apply settings
        function applySettings(e) {
            e.preventDefault();
            
            printSettings.clinic = document.getElementById('clinicSelect').value;
            printSettings.fromNumber = parseInt(document.getElementById('fromNumber').value);
            printSettings.toNumber = parseInt(document.getElementById('toNumber').value);
            printSettings.waitTime = parseInt(document.getElementById('waitTime').value);
            printSettings.centerName = document.getElementById('centerName').value;
            
            if (!printSettings.clinic) {
                showNotification('يرجى اختيار عيادة', 'error');
                return;
            }
            
            if (printSettings.fromNumber > printSettings.toNumber) {
                showNotification('رقم البداية يجب أن يكون أقل من رقم النهاية', 'error');
                return;
            }
            
            generateTickets();
            hideSettingsModal();
            showNotification('تم تطبيق الإعدادات');
        }

        // Generate tickets
        function generateTickets() {
            const ticketsGrid = document.getElementById('ticketsGrid');
            const centerName = document.getElementById('printCenterName');
            const currentDate = new Date();
            
            centerName.textContent = printSettings.centerName;
            document.getElementById('printDate').textContent = currentDate.toLocaleDateString('ar-SA');
            
            ticketsGrid.innerHTML = '';
            
            for (let i = printSettings.fromNumber; i <= printSettings.toNumber; i++) {
                const ticket = createTicket(i, currentDate);
                ticketsGrid.appendChild(ticket);
            }
            
            showNotification(`تم إنشاء ${printSettings.toNumber - printSettings.fromNumber + 1} تذكرة`);
        }

        // Create ticket
        function createTicket(number, date) {
            const ticket = document.createElement('div');
            ticket.className = 'ticket';
            
            const waitTime = (number - printSettings.fromNumber) * printSettings.waitTime;
            
            ticket.innerHTML = `
                <div class="ticket-center">${printSettings.centerName}</div>
                <div class="ticket-number arabic-number">${convertToArabicNumbers(number)}</div>
                <div class="ticket-date">${date.toLocaleDateString('ar-SA')}</div>
                <div class="ticket-wait">وقت الانتظار: ${convertToArabicNumbers(waitTime)} دقيقة</div>
            `;
            
            return ticket;
        }

        // Print tickets
        function printTickets() {
            if (document.getElementById('ticketsGrid').children.length === 0) {
                showNotification('يرجى إنشاء التذاكر أولاً', 'error');
                return;
            }
            
            window.print();
            showNotification('جاري الطباعة...');
        }

        // Update print date
        function updatePrintDate() {
            const now = new Date();
            document.getElementById('printDate').textContent = now.toLocaleDateString('ar-SA', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white px-6 py-3 rounded-lg shadow-lg show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Handle print events
        window.addEventListener('beforeprint', function() {
            document.body.classList.add('printing');
        });

        window.addEventListener('afterprint', function() {
            document.body.classList.remove('printing');
            showNotification('تمت الطباعة بنجاح');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                printTickets();
            } else if (e.key === 'Escape') {
                hideSettingsModal();
            }
        });

        // Initialize animations
        anime({
            targets: '.ticket',
            scale: [0.8, 1],
            opacity: [0, 1],
            delay: anime.stagger(100),
            duration: 600,
            easing: 'easeOutQuart'
        });
    </script>
</body>
</html>